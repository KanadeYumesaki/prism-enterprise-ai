# Prism RAG ハイブリッド検索テスト仕様 — テストケース定義

このファイルでは、HybridRetriever の動作を確認するためのテストケースを定義する。

- FTS（キーワード / 完全一致）テスト
- ベクトル検索テスト
- ハイブリッドテスト
- ネガティブテスト

---

## 1. テストケース一覧（サマリ）

| ID           | 種別        | 入力クエリ例                                                                 | 主な狙い                                            |
|--------------|-------------|-------------------------------------------------------------------------------|-----------------------------------------------------|
| T-FTS-01     | キーワード  | 「PROJ-A77 の物品購入の最大許容額はいくらですか？」                          | D1 のみを正しくヒットさせる（完全一致）             |
| T-FTS-02     | キーワード  | 「PROJ-A78 の物品購入の最大許容額はいくらですか？」                          | D2 を優先してヒットさせる（似たIDとの区別）         |
| T-FTS-NEG-01 | キーワード  | 「PROJ-XXX の物品購入の最大許容額はいくらですか？」                          | 該当なし時の挙動（無理に他案件を拾わない）          |
| T-VEC-01     | ベクトル    | 「社内システムへのアクセス制御は、どんな思想に基づいて設計されていますか？」 | 「ゼロトラスト」に言及せずに D3 を意味検索で特定    |
| T-VEC-NEG-01 | ベクトル    | 「従業員の健康管理の基本方針を教えてください」                               | セキュリティ文書に誤マッチしないこと                |
| T-HYB-01     | ハイブリッド | 「R-2025.11.15 のリリース時に発生した DB エラーのコードと原因ユーザーは？」 | D4 から release 名＋エラーコード＋ユーザーを抽出    |
| T-HYB-02     | ハイブリッド | 「11月15日のデプロイでどんな DB 障害が起きて、誰が原因でしたか？」          | 日付表現から D4 を意味検索しつつ、ID はキーワードで |

---

## 2. 各テストケース詳細

### 2.1 T-FTS-01: PROJ-A77 の最大許容額

- 種別: キーワード検索（FTS / 完全一致）
- 前提:
  - D1〜D4 がすべて RAG に登録済み
- 入力クエリ:
  - 「PROJ-A77 の物品購入の最大許容額はいくらですか？」
- 期待される挙動:
  1. 検索結果の上位に D1 が表示される（D2 より上位）
  2. 回答文中に「1 回あたり 5000 JPY」と明示される
  3. PROJ-A78（8000 JPY）の情報を混在させない

---

### 2.2 T-FTS-02: PROJ-A78 の最大許容額

- 種別: キーワード検索
- 入力クエリ:
  - 「PROJ-A78 の物品購入の最大許容額はいくらですか？」
- 期待される挙動:
  1. 検索結果の上位に D2 が表示される（D1 より上位）
  2. 回答文中に「1 回あたり 8000 JPY」と明示される
  3. PROJ-A77（5000 JPY）の情報を誤って引用しない

---

### 2.3 T-FTS-NEG-01: 存在しないプロジェクト ID

- 種別: キーワード検索（ネガティブテスト）
- 入力クエリ:
  - 「PROJ-XXX の物品購入の最大許容額はいくらですか？」
- 期待される挙動:
  1. 検索結果に D1 / D2 が安易にマッチしない（スコアが低い）
  2. 回答としては「該当するルールが見つかりませんでした」等の形で不明を返す

---

### 2.4 T-VEC-01: アクセス制御の思想（ゼロトラストの意味検索）

- 種別: ベクトル検索
- 入力クエリ:
  - 「社内システムへのアクセス制御は、どんな思想に基づいて設計されていますか？」
- 期待される挙動:
  1. 検索結果の上位に D3 が表示される
  2. 回答文中に「ゼロトラスト・アーキテクチャ」「社内ネットワークを安全とは見なさない」等の要点が含まれる
  3. クエリに「セキュリティ」「ゼロトラスト」という単語がなくても正しくヒットする

---

### 2.5 T-VEC-NEG-01: 無関係なヘルスケア質問

- 種別: ベクトル検索（ネガティブテスト）
- 入力クエリ:
  - 「従業員の健康管理の基本方針を教えてください」
- 期待される挙動:
  1. D3 を強引にマッチさせない（スコアが低く、他文書と大差がない）
  2. 回答としては「健康管理に関する文書は登録されていません」等の形で不明を返す

---

### 2.6 T-HYB-01: リリース名から DB エラーとユーザーを特定

- 種別: ハイブリッド検索
- 入力クエリ:
  - 「R-2025.11.15 のリリース時に発生した DB エラーのコードと、原因となったサービスアカウント名を教えてください。」
- 期待される挙動:
  1. 検索結果の最上位に D4 が表示される
  2. 回答文中に次の 2 点が含まれる  
     - エラーコード: `DB-LOCK-001`  
     - サービスアカウント名: `service-user`

---

### 2.7 T-HYB-02: 日付だけから DB 障害を特定

- 種別: ハイブリッド検索
- 入力クエリ:
  - 「11月15日のデプロイでどんな DB 障害が起きて、誰が原因でしたか？」
- 期待される挙動:
  1. D4 が最上位に表示される
  2. 回答内容として、  
     - 「デプロイ自体は成功した」  
     - 「その後 DB-LOCK-001 エラーが発生した」  
     - 「原因ユーザーは service-user である」  
     の 3 点を含む
