# Prism RAG ハイブリッド検索テスト仕様 — 実行手順と評価基準

このファイルでは、`rag_test_documents.md` / `rag_test_cases.md` で定義した内容を実際に検証するための手順と評価基準を定義する。

---

## 1. 前提条件・環境

- Python: 3.12 系
- 使用する仮想環境: `backend/.venv`
- バックエンド:
  - `backend/rag_kernel.py` の HybridRetriever 実装
  - ベクトルストア: ChromaDB
  - キーワード検索: SQLite / FTS（または同等）
- フロントエンド:
  - Prism の「Knowledge Base Management」画面からファイル登録ができること
  - New Chat で通常どおり質問できること
- Embedding モデル:
  - Prism の設定に従う。モデル名はテスト実行ログに残す。

---

## 2. 実行手順

### 2.1 インデックスの初期化（任意）

1. 既存のテストデータが混ざっている場合は、テスト用コレクションを再作成するか、RAG ストレージをクリアする。
2. ChromaDB / SQLite のストレージパス（例: `data/chroma/`, `data/rag.db`）をメモしておく。

### 2.2 テストドキュメントの登録

1. Prism フロントエンドの「Knowledge Base Management」画面を開く。
2. `rag_test_documents.md` に従って作成した D1〜D4 をドラッグ＆ドロップでアップロードする。
3. 「Register to RAG」ボタンを押し、インデックス登録が完了するまで待つ。
4. 対象コレクションのドキュメント数が 4 件になっていることを確認する。

### 2.3 テストケースの実行

1. 「New Chat」からチャット画面に戻る。
2. `rag_test_cases.md` に定義した T-FTS / T-VEC / T-HYB の各テストケースを、上から順番に実行する。
3. 各テストケースについて、次の情報をメモしておく（Markdown で十分）:
   - 実行日 / 実行者
   - 入力クエリ
   - RAG が返した上位 3 件のドキュメント（ID / タイトル / スコア）
   - モデルの最終回答（サマリで可）

> メモ: 上位 3 件のスコアが見えない場合は、バックエンドのログ出力にスコアを出すようにしておくと診断が楽になる。

---

## 3. 合否判定基準

### 3.1 スイート全体の合格条件

以下をすべて満たした場合、今回のハイブリッド検索テストは「合格」とみなす。

- T-FTS-01, T-FTS-02, T-VEC-01, T-HYB-01, T-HYB-02 が **Pass**
- T-FTS-NEG-01, T-VEC-NEG-01 が「該当なし」または安全な応答になっている（無理な補完をしない）

### 3.2 部分的な診断

- FTS 系のみ Fail の場合
  - SQLite / FTS 設定（トークナイズ、正規化、クエリ構文）を疑う
- ベクトル系のみ Fail の場合
  - Embedding モデルの変更
  - 埋め込み前処理（正規化、チャンクサイズ、ドキュメント分割）を確認
- ハイブリッド系のみ Fail の場合
  - HybridRetriever のスコアリング・重み付けロジックを調整  
    （例: ID 一致スコアに重みを増やす 等）
- ドキュメント取得は正しいが回答が誤っている場合
  - LLM 応答生成のプロンプト／システムメッセージを調整する

---

## 4. ログの残し方（自分用）

Git で履歴を追いやすくするため、テスト結果は次のようなスタイルで残しておくと便利。

```markdown
# RAG ハイブリッドテスト実行ログ 2025-11-20

- 環境: backend/.venv (Python 3.12), Embedding: XXX-Embedding-v1
- コミットID: abcdef1234

## T-FTS-01

- クエリ: 「PROJ-A77 の物品購入の最大許容額はいくらですか？」
- 上位ドキュメント:
  - 1位: D1 (score=0.92)
  - 2位: D2 (score=0.10)
- 結果: 「1 回あたり 5000 JPY」と回答 → Pass

...（以下、各テストケースごとに記録）
```

この形式で `logs/rag_hybrid_test_YYYYMMDD.md` などを作成し、Git にコミットしていく想定。
